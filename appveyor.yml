version: 0.1.{build}
image: Visual Studio 2019
configuration: Release
platform: Any CPU

skip_branch_with_pr: true

environment:
  semver_suffix: preview
  sonarcloud_token:
    secure: WSZCNtuf3h9M4BxNiFQ7SQPwGkg3+LqSMZRyfYruiicYvc1BzYaN90n8pNEsPAKs
  snk_passphrase: 
    secure: Wl4NefzdMAo7GP7gP11aWDrxKoQPC0eN78TZFcZBbHGMW3geBDFu40RVF1GxTFUaFzN/lAcQ3qL9m8huHSWLBg==
  snk_salt:
    secure: tIuRlNokDRTBkah55IRfeATr4WWOEfQOLDqUjrDMMcPEmgq4yOTHzQFKEky67G9rk51D2VvdMFsTcDQrecDonA==
  github_token:
    secure: znqLAqC1gUZtlVY6m6JBqkg0jZI2JUZbntH6E/rDojnWPVjFkZ75gD88x26wb7zQ

init:
  - ps: dotnet nuget add source "https://nuget.pkg.github.com/winnster/index.json" -n github -u winnster -p "$env:github_token" --store-password-in-clear-text
  - ps: echo $env:github_token

install:
  - cmd: choco install secure-file --ignore-checksums
  - ps: dotnet tool install dotnet-sonarscanner --global
  - ps: dotnet restore

dotnet_csproj:
  patch: true
  file: '**\*.csproj'
  version_prefix: '{version}'

nuget:
  disable_publish_on_pr: true

before_build:
  - cmd: secure-file.exe -decrypt Winnster.snk.enc -secret %snk_passphrase% -salt %snk_salt%
  - ps: dotnet sonarscanner begin /k:"AutomationFoundation" /v:"$env:APPVEYOR_BUILD_VERSION-$env:semver_suffix" /d:"sonar.branch.name=$env:APPVEYOR_REPO_BRANCH" /d:"sonar.host.url=https://sonarcloud.io" /o:"winnster" /d:"sonar.login=$env:sonarcloud_token" /d:"sonar.cs.nunit.reportsPaths=**/TestResults.xml" /d:"sonar.cs.opencover.reportsPaths=**/coverage.opencover.xml" /d:"sonar.exclusions=**\Interop\**,**\Primitives\**,**\tools\**"

build_script:
  - ps: dotnet build AutomationFoundation.sln /p:Configuration="$env:Configuration" /p:Platform="$env:Platform" --version-suffix "$env:semver_suffix"

test_script:
  - ps: dotnet test AutomationFoundation.sln /p:Configuration="$env:Configuration" /p:Platform="$env:Platform" /p:CollectCoverage=true /p:CoverletOutputFormat=opencover /p:CoverletOutput=".\TestResults\coverage.opencover.xml" --no-build --logger nunit

after_test:
  - ps: dotnet sonarscanner end /d:"sonar.login=$env:sonarcloud_token"

artifacts:
  - path: '**\*.nupkg'
    name: Package
  - path: '**\TestResults.xml'
    name: Test Result
  - path: '**\coverage.opencover.xml'
    name: Coverage Result

deploy_script:
  - ps: dotnet nuget push "**\*.nupkg" --source github